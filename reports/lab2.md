# ch3 实验报告

## 编程作业

### 任务

- 重写 sys_get_time 和 sys_task_info
- mmap 和 munmap 匿名映射

### 实验过程

虚拟地址空间中

#### 重写 sys_get_time 和 sys_task_info

- 在内存管理中增加 translated_mut_ptr 函数，实现进程用户地址空间中的指针到可变引用的转换
- 其余类似 ch3 中的操作

#### mmap 和 munmap 匿名映射

- 内存管理接口
  - delete_frame_area
- 任务管理接口
  - mmap：调用insert_framed_area增加映射区域
  - munmap：调用delete_frame_area删除映射区域
- 系统调用的实现
  - 合法性检验
  - 调用任务管理接口 mmap 和 munmap

## 问答题

### 1

- `[63:54]` 保留位
- `[53:10]` 物理页号
- `[9:8]` RSW: 预留给系统管理员使用
- `[7:0]` 标志位
  - V(Valid): 仅当位 V 为 1 时，页表项才是合法的
  - R(Read)/W(Write)/X(eXecute): 分别控制索引到这个页表项的对应虚拟页面是否允许读/写/执行
  - U(User): 控制索引到这个页表项的对应虚拟页面是否在 CPU 处于 U 特权级的情况下是否被允许访问
  - G(Global): 全局映射，用于TLB
  - A(Accessed): 处理器记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被访问过
  - D(Dirty): 处理器记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被修改过

### 2

- Instruction Page Fault、Load Page Faul、Store Page Fault、Fetch Page Fault
- 缺页异常会导致MMU返回一个中断，并在 `scause` 设置导致缺页中断的原因

- 减少task驻留在内存时所需要的内存大小

- 10kb数量级
- 延迟映射：分配时不映射，当应用进程访问某个虚拟页但页表中没有映射时触发缺页中断，此时再为该虚拟页分配物理页帧并在页表中添加映射

- 将页表项V位标记为0

### 3

- 修改页表基地址寄存器 `satp`
- 设置标志位 U
- 在内核态可以直接通过 MMU 访问用户空间地址，不需要软件模拟页表查询。
- 双页表实现下Trap/任务切换时更换页表。单页表操作系统，在切换任务时更新页表。


## 荣誉准则

1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与以下各位就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

2. 此外，我也参考了以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。
